<!DOCTYPE html><html><head><meta charset="utf-8"><title>Attaching and formatting drives with Azure ARM and PowerShell | Naeem Khedarun</title><meta name="author" content="Naeem Khedarun"><meta name="description" content="Setting up a virtual machine in Azure using ARM has been made straightforward, even with one-click deployments. If you have any services that need a bigger disk, there are a few more moving parts to get it working."><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:title" content="Attaching and formatting drives with Azure ARM and PowerShell"><meta property="og:site_name" content="Naeem Khedarun"><meta property="og:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png"><meta property="og:description" content="Setting up a virtual machine in Azure using ARM has been made straightforward, even with one-click deployments. If you have any services that need a bigger disk, there are a few more moving parts to get it working."><meta name="twitter:description" content="Setting up a virtual machine in Azure using ARM has been made straightforward, even with one-click deployments. If you have any services that need a bigger disk, there are a few more moving parts to get it working."><meta property="og:url" content="http://naeem.khedarun.co.uk/blog/2015/12/03/attaching-and-formatting-drives-with-azure-arm-and-powershell/"><meta name="twitter:site" content="@NaeemKhedarun"><meta name="twitter:creator" content="@NaeemKhedarun"><meta name="twitter:title" content="Attaching and formatting drives with Azure ARM and PowerShell"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png"><link rel="alternate" href="/blog/atom.xml" title="Naeem Khedarun" type="application/atom+xml"><link rel="stylesheet" href="/css/all-8d968265be.min.css"><script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1','packages':['corechart']}]}"></script></head><body><div id="wrap"><div class="navbar navbar-static-top" role="navigation"><div class="container"><div class="col-12 navbar-center"><a href="/blog/"><span class="name-brand">Naeem Khedarun</span></a> <span class="navbar-spacer"></span> <span><a href="https://twitter.com/naeemkhedarun"><i class="fa fa-twitter"></i></a> <a href="https://github.com/naeemkhedarun"><i class="fa fa-github"></i></a> <a href="https://uk.linkedin.com/in/naeemkhedarun"><i class="fa fa-linkedin-square"></i></a> <a href="/blog/atom.xml"><i class="fa fa-rss"></i></a></span></div></div></div><div class="container"><div class="row"><div class="col-12 col-md-12"><h1 class="title">Attaching and formatting drives with Azure ARM and PowerShell</h1><i>2 months ago</i><p></p><p>Setting up a virtual machine in Azure using ARM has been made straightforward, even with one-click deployments. If you have any services that need a bigger disk, there are a few more moving parts to get it working. This is based on the <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/windows-vm-custom-script" target="_blank" rel="external">custom script quickstart template</a> and <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2013/05/29/use-powershell-to-initialize-raw-disks-and-partition-and-format-volumes.aspx" target="_blank" rel="external">Ed Wilsons formatting script article</a></p><h3 id="Attach_a_disk">Attach a disk</h3><p>To attach a data disk to the virtual machine you can use the following configuration just below the osDisk definition.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      "<span class="attribute">dataDisks</span>":<span class="value">[&#123;</span><br><span class="line">            "<span class="attribute">lun</span>":<span class="value"><span class="number">0</span></span>,</span><br><span class="line">            "<span class="attribute">name</span>":<span class="value"><span class="string">"datadisk"</span></span>,</span><br><span class="line">            "<span class="attribute">diskSizeGB</span>":<span class="value"><span class="number">1000</span></span>,</span><br><span class="line">            "<span class="attribute">createOption</span>":<span class="value"><span class="string">"Empty"</span></span>,</span><br><span class="line">            "<span class="attribute">vhd</span>":<span class="value">&#123;</span><br><span class="line">                  "<span class="attribute">Uri</span>":<span class="value"><span class="string">"[variables('dataDiskUri')]"</span></span><br><span class="line">            </span>&#125;</span><br><span class="line">      </span>&#125;]</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure><ul><li>lun (Logical Unit Number) should be unique for each attached disk and starts from zero.</li><li>diskSizeGB has a maximum of 1000 (1 TB) in Azure currently.</li><li>createOption should be “Empty” for a new disk.</li><li>vhd.Uri is the full path you want the blob created in.</li></ul><p>If we deployed the template with this now, we will get a raw unformatted disk with no drive label. You can view it in Disk Manager or by running the following PowerShell on the box.</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Get-Disk | Where partitionstyle <span class="operator">-eq</span> <span class="string">'raw'</span></span><br></pre></td></tr></table></figure><p>We need one more resource to complete the deployment and give us a formatted disk. We can use the CustomScriptExtension to run a PowerShell script which will format any raw attached disks (in case you want to do multiple drives).</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   "<span class="attribute">type</span>":<span class="value"><span class="string">"Microsoft.Compute/virtualMachines/extensions"</span></span>,</span><br><span class="line">   "<span class="attribute">name</span>":<span class="value"><span class="string">"[concat(variables('vmName'),'/InitialiseDisks')]"</span></span>,</span><br><span class="line">   "<span class="attribute">apiVersion</span>":<span class="value"><span class="string">"2015-05-01-preview"</span></span>,</span><br><span class="line">   "<span class="attribute">location</span>":<span class="value"><span class="string">"[resourceGroup().location]"</span></span>,</span><br><span class="line">   "<span class="attribute">dependsOn</span>":<span class="value">[</span><br><span class="line">      <span class="string">"[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"</span></span><br><span class="line">   ]</span>,</span><br><span class="line">   "<span class="attribute">properties</span>":<span class="value">&#123;</span><br><span class="line">      "<span class="attribute">publisher</span>":<span class="value"><span class="string">"Microsoft.Compute"</span></span>,</span><br><span class="line">      "<span class="attribute">type</span>":<span class="value"><span class="string">"CustomScriptExtension"</span></span>,</span><br><span class="line">      "<span class="attribute">typeHandlerVersion</span>":<span class="value"><span class="string">"1.2"</span></span>,</span><br><span class="line">      "<span class="attribute">settings</span>":<span class="value">&#123;</span><br><span class="line">         "<span class="attribute">fileUris</span>":<span class="value">[</span><br><span class="line">            <span class="string">"[variables('initialiseDisksScript')]"</span></span><br><span class="line">         ]</span>,</span><br><span class="line">         "<span class="attribute">commandToExecute</span>":<span class="value"><span class="string">"[concat('powershell -ExecutionPolicy Unrestricted -file ',parameters('scriptName'))]"</span></span><br><span class="line">      </span>&#125;</span><br><span class="line">   </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure><ul><li>dependsOn will need to be the resource path for our virtual machine to ensure this extension is run after its provisioned.</li><li>fileUris is an array of any files we want downloaded and made available to execute. <strong>This needs to be a path to an azure blob</strong>, unfortunately you cannot link to any other domains like github.</li><li>commandToExecute is a cmd.exe command, so we need to call out to powershell to invoke our script. The working directory will have your downloaded file already there, so you don’t need the full path to execute it, just the name.</li></ul><p>You will need to upload the following script to a blob:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Get-Disk | ` </span><br><span class="line">Where partitionstyle <span class="operator">-eq</span> <span class="string">'raw'</span> | ` </span><br><span class="line">Initialize-Disk -PartitionStyle MBR -PassThru | ` </span><br><span class="line">New-Partition -AssignDriveLetter -UseMaximumSize | ` </span><br><span class="line">Format-Volume -FileSystem NTFS -NewFileSystemLabel <span class="string">"datadisk"</span> -Confirm:<span class="variable">$false</span></span><br></pre></td></tr></table></figure><div class="categories"><span>Posted in:</span><a href="/blog/categories/operations/">operations</a></div><div class="tags"><span>Tagged with:</span><a href="/blog/tags/azure/">azure</a>, <a href="/blog/tags/powershell/">powershell</a></div><br><hr><div class="row"><div class="col-md-12"><h3>Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div></div></div><div id="push"></div></div><div id="footer"><div class="container"><div class="container"><br><p class="muted credit">&copy; 2016 Naeem Khedarun</p></div></div></div><script src="/js/all-4c3c81d67b.min.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71815871-1', 'auto');
ga('send', 'pageview');</script><script type="text/javascript">var disqus_shortname = 'naeemkhedarun';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());</script></body></html>