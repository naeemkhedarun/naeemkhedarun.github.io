<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>A look at performance on .NET dynamic proxies | Naeem Khedarun</title>
  <meta name="author" content="Naeem Khedarun">
  
  <meta name="description" content="I needed to proxy our service fabric actors to trace call timings and I wanted to see if their interception package was competitive with other open source offerings.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta property="og:title" content="A look at performance on .NET dynamic proxies"/>
  <meta property="og:site_name" content="Naeem Khedarun"/>

  
    <meta property="og:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png"/>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png" />
  
  
  
    <meta property="og:description" content="I needed to proxy our service fabric actors to trace call timings and I wanted to see if their interception package was competitive with other open source offerings."/>
    <meta name="twitter:description" content="I needed to proxy our service fabric actors to trace call timings and I wanted to see if their interception package was competitive with other open source offerings.">
  
  <meta property="og:url" content="http://naeem.khedarun.co.uk/blog/blog/2016/01/18/a-look-at-performance-on-dotnet-dynamic-proxies-1448894394346/"/>
  
  <meta name="twitter:site" content="@NaeemKhedarun">
  <meta name="twitter:creator" content="@NaeemKhedarun">
  <meta name="twitter:title" content="A look at performance on .NET dynamic proxies">
  
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <link rel="alternate" href="/blog/atom.xml" title="Naeem Khedarun" type="application/atom+xml">
  
  <!-- build:css -->
  
  <link rel="stylesheet" href="css/main.css">
  
  
  <link rel="stylesheet" href="css/monokai_sublime.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <!-- endbuild -->


<script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1','packages':['corechart']}]}">
</script>
</head>

<body>
  <div id="wrap">
    
    <div class="navbar navbar-static-top " role="navigation">
  <div class="container">
    <div class="col-12 navbar-center">
      
      <a href="/blog/"><span class="name-brand">Naeem Khedarun</span></a>
      <span class="navbar-spacer"></span>
      <span>
        <a href="https://twitter.com/naeemkhedarun"><i class="fa fa-twitter"></i></a>
        <a href="https://github.com/naeemkhedarun"><i class="fa fa-github"></i></a>
        <a href="https://uk.linkedin.com/in/naeemkhedarun"><i class="fa fa-linkedin-square"></i></a>
        <a href="/blog/atom.xml"><i class="fa fa-rss"></i></a>
      </span>
      
    </div>
  </div>
</div>

    
      <div class="container">
        <div class="row">
          <div class="col-12 col-md-12">
  
  
    <h1 class="title">A look at performance on .NET dynamic proxies</h1>
  

  <i>10 months ago</i>

<p>

  <p>I currently use <a href="http://www.lightinject.net/" target="_blank" rel="external">LightInject</a> for dependency injection primarily for its good performance and well documented features. I needed to proxy our service fabric actors to trace call timings and I wanted to see if their <a href="http://www.lightinject.net/#interception" target="_blank" rel="external">interception</a> package was competitive with other open source offerings.</p>
<p>We’ll take a look at:</p>
<ul>
<li><a href="https://github.com/castleproject/Core" target="_blank" rel="external">Castle Dynamic Proxy</a> - This is likely the most popular dynamic proxy library for .NET.</li>
<li><a href="http://www.lightinject.net/#interception" target="_blank" rel="external">LightInject Interceptor</a> - I hadn’t heard of this one until I started using LightInject.</li>
<li><a href="https://github.com/mtamme/NProxy" target="_blank" rel="external">NProxy</a> - Also a new one to me, but I’ve added it since it is easy to use.</li>
</ul>
<h3 id="Creating-proxy-instances"><a href="#Creating-proxy-instances" class="headerlink" title="Creating proxy instances"></a>Creating proxy instances</h3><chart type="BarChart" options="{'legend':{'position':'bottom'}, 'height':'300'}"><br>  <div></div><br></chart>

<table>
<thead>
<tr>
<th>Library</th>
<th>Average Time (us)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Castle</td>
<td>2.5237 us</td>
</tr>
<tr>
<td>LightInject</td>
<td>1047.9463 us</td>
</tr>
<tr>
<td>NProxy</td>
<td>1.7470 us</td>
</tr>
</tbody>
</table>
<p>I was quite surprised to see such a difference between the frameworks. I guessed that both NProxy and Castle cache their proxy types internally, which LightInject expects you to handle your own caching. Something good to bear in mind! </p>
<p>After caching the proxy type things are a little more competitive:</p>
<chart type="BarChart" options="{'legend':{'position':'bottom'}, 'height':'300'}"><br>  <div></div><br></chart>

<table>
<thead>
<tr>
<th>Library</th>
<th>Average Time (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Castle</td>
<td>2437.7655 ns</td>
</tr>
<tr>
<td>LightInject</td>
<td>100.6836 ns</td>
</tr>
<tr>
<td>NProxy</td>
<td>1670.7880 ns</td>
</tr>
</tbody>
</table>
<p>I still think the code can be more optimal in all cases, so I reduced everything as much as possible to a single call to activate the proxy type. I’ve included timings for <code>Activator.CreateInstance</code> and the standard constructor against the non-proxy type as a baseline.</p>
<chart type="BarChart" options="{'legend':{'position':'bottom'}, 'height':'300'}"><br>  <div></div><br></chart>

<table>
<thead>
<tr>
<th>Library</th>
<th>Average Time (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Castle</td>
<td>109.5888 ns</td>
</tr>
<tr>
<td>LightInject</td>
<td>99.2248 ns</td>
</tr>
<tr>
<td>NProxy</td>
<td>1041.4311 ns</td>
</tr>
<tr>
<td>Activator</td>
<td>77.9584 ns</td>
</tr>
<tr>
<td>Constructor</td>
<td>6.7176 ns</td>
</tr>
</tbody>
</table>
<p>Things are much closer now! The difference between Castle and LightInject are negligible. There might be a way to optimise NProxy further but the API didn’t yield any obvious optimisations.</p>
<h3 id="Calling-proxied-methods"><a href="#Calling-proxied-methods" class="headerlink" title="Calling proxied methods"></a>Calling proxied methods</h3><p>Now let’s take a look at the runtime overhead of calling a proxied object. I’ve included an unproxied instance as a baseline.</p>
<chart type="BarChart" options="{'hAxis':{'baseline':0}, 'legend':{'position':'bottom'}, 'height':'300'}"><br>  <div></div><br></chart>

<table>
<thead>
<tr>
<th>Library</th>
<th>Average Time (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Castle</td>
<td>2.9992 ns</td>
</tr>
<tr>
<td>LightInject</td>
<td>2.9826 ns</td>
</tr>
<tr>
<td>NProxy</td>
<td>2.9893 ns</td>
</tr>
<tr>
<td>No Proxy</td>
<td>3.0494 ns</td>
</tr>
</tbody>
</table>
<p>Surprisingly there is no overhead with any of the libraries with calling the proxied object. The graph looks skewed due to how close the results are and the timings are in nanoseconds. This is great news and we can use whichever library we want guilt-free. </p>
<p>You can review the code for the benchmarks on <a href="https://github.com/naeemkhedarun/Benchmarks/blob/master/Benchmarking/DynamicProxyBenchmark.cs" target="_blank" rel="external">github</a>.</p>


</p>

  
  
  
  <div class="categories">
    <span>Posted in: </span><a href="/blog/categories/development/">development</a>
  </div>


  
  
  <div class="tags">
    <span>Tagged with: </span><a href="/blog/tags/NET/">.NET</a>
  </div>


<br />
<hr />

<div class="row">
<div class="col-md-12">
  <h3>Comments</h3>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  </div>
</div>


</div>
        </div>
    
    </div>
    <div id="push"></div>
  </div>
  
<div id="footer">
  <div class="container">
    <div class="container">
    
    <br />
      <p class="muted credit">
        
        &copy; 2016 Naeem Khedarun
        
      </p>
    </div>
  </div>
</div>
  <!-- build:js -->
<script src="/blog/js/jquery.js"></script>

<script src="/blog/js/respond.min.js"></script>
<script src="/blog/js/graphs.js"></script>
<!-- endbuild -->


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71815871-1', 'auto');
ga('send', 'pageview');
</script>



<script type="text/javascript">
var disqus_shortname = 'naeemkhedarun';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>


</body>
</html>
