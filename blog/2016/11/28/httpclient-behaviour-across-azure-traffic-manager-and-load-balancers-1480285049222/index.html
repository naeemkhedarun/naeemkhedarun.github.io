<!DOCTYPE html><html><head><meta charset="utf-8"><title>HttpClient DNS settings for Azure Cloud Services and Traffic Manager | Naeem Khedarun</title><meta name="author" content="Naeem Khedarun"><meta name="description" content="At my current workplace, some of our systems are approaching 1 Billion requests per day. At these volumes sub-optimal configuration between systems ca"><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:title" content="HttpClient DNS settings for Azure Cloud Services and Traffic Manager"><meta property="og:site_name" content="Naeem Khedarun"><meta property="og:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://naeem.khedarun.co.uk/blog/images/code-cover.png"><meta property="og:url" content="http://naeem.khedarun.co.uk/blog/blog/2016/11/28/httpclient-behaviour-across-azure-traffic-manager-and-load-balancers-1480285049222/"><meta name="twitter:site" content="@NaeemKhedarun"><meta name="twitter:creator" content="@NaeemKhedarun"><meta name="twitter:title" content="HttpClient DNS settings for Azure Cloud Services and Traffic Manager"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png"><link rel="alternate" href="/blog/atom.xml" title="Naeem Khedarun" type="application/atom+xml"><link rel="stylesheet" href="/css/all-3c8e9c6215.min.css"><script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1','packages':['corechart']}]}"></script></head><body><div id="wrap"><div class="navbar navbar-static-top" role="navigation"><div class="container"><div class="col-12 navbar-center"><a href="/blog/"><span class="name-brand">Naeem Khedarun</span></a> <span class="navbar-spacer"></span> <span><a href="https://twitter.com/naeemkhedarun"><i class="fa fa-twitter"></i></a> <a href="https://github.com/naeemkhedarun"><i class="fa fa-github"></i></a> <a href="https://uk.linkedin.com/in/naeemkhedarun"><i class="fa fa-linkedin-square"></i></a> <a href="/blog/atom.xml"><i class="fa fa-rss"></i></a></span></div></div></div><div class="container"><div class="row"><div class="col-12 col-md-12"><h1 class="title">HttpClient DNS settings for Azure Cloud Services and Traffic Manager</h1><i>2 days ago</i><p></p><p>At my current workplace, some of our systems are approaching 1 Billion requests per day. At these volumes sub-optimal configuration between systems can cause significant issues and subtle performance degradation. To understand some of the issues we are facing I’m going back to basics.</p><p>Thanks to <a href="http://byterot.blogspot.co.uk/2016/07/singleton-httpclient-dns.html" target="_blank" rel="external">Aliostad</a> for his analysis on the HttpClient and <a href="https://github.com/fschwiet/PSHostsFile" target="_blank" rel="external">fschwiet</a> for writing the .NET hosts library which I’ve now taken off my own to-do list.</p><p>There are two DNS level scenarios that I want to investigate:</p><ul><li>Connect to the production cloud service slot after a VIP swap. Clients connect to a cloud service using a <code>cloudapp.net</code> DNS name which points to the Azure Load Balancer distributing traffic over the nodes.</li><li>Resolve the latest Traffic Manager configuration. Traffic manager is a DNS level load balancer. Clients resolve a traffic manager address to an IP address and connect directly to the endpoint. So what happens when the IP changes? We’ll try the scenario with both a Transient and Singleton HttpClient.</li></ul><h4 id="Transient"><a href="#Transient" class="headerlink" title="Transient"></a>Transient</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><div class="line">[Fact]</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">TransientTimeoutTest</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    HostsFile.Set(_hostname, <span class="string">"127.0.0.1"</span>);</div><div class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> TransientHttpClient(<span class="keyword">new</span> Uri(<span class="string">$"http://<span class="subst">&#123;_hostname&#125;</span>:9200"</span>));</div><div class="line"></div><div class="line">    <span class="keyword">var</span> timer = Stopwatch.StartNew();</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">await</span> <span class="keyword">new</span> LoopUntilFailure(client).ExecuteAsync(</div><div class="line">            () =&gt; Task.Run(() =&gt; HostsFile.Set(_hostname, <span class="string">"128.0.0.1"</span>)));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span></div><div class="line">    &#123;</div><div class="line">        _logger.WriteLine(timer.ElapsedMilliseconds.ToString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><blockquote><p>133721ms</p></blockquote><p>The transient client eventually behaves as expected despite taking 133 seconds to respect the change. The <a href="https://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.dnsrefreshtimeout.aspx" target="_blank" rel="external">ServicePointManager.DnsRefreshTimeout</a> defaults to 120 seconds. This still leaves 13 seconds unaccounted for which I suspect is the final socket connection timeout.</p><p>A test isolating the connection to the non-responsive endpoint yields:</p><blockquote><p>13086ms</p></blockquote><p>I wasn’t able to find any configuration for this timeout within .NET but I didn’t manage to trace the framework source to an enumeration <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms740668.aspx#WSAETIMEDOUT" target="_blank" rel="external">WSAETIMEDOUT</a>. The timeout is controlled by the OS documented <a href="https://technet.microsoft.com/en-us/library/cc938208.aspx" target="_blank" rel="external">here</a>.</p><blockquote><p>TCP/IP adjusts the frequency of retransmissions over time. The delay between the first and second retransmission is three seconds. This delay doubles after each attempt. After the final attempt, TCP/IP waits for an interval equal to double the last delay, and then it closes the connection request.</p></blockquote><p>You find the default values for your OS (<em>in my case Windows Server 2016</em>) by running:</p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#  netsh interface tcp show global</div><div class="line">Querying active state...</div><div class="line"></div><div class="line">TCP Global Parameters</div><div class="line">----------------------------------------------</div><div class="line">Initial RTO              : 3000</div><div class="line">Max SYN Retransmissions  : 2</div></pre></td></tr></table></figure><p>So the result should be <code>(1 * 3000) + (2 * 3000) = 12000ms</code> which explains the extra time. Now the result is understood, let’s re-run the test after dropping the DNS refresh timeout to 10 seconds.</p><figure class="highlight csharp"><table><tr><td class="code"><pre><div class="line">ServicePointManager.DnsRefreshTimeout = <span class="number">10000</span>;</div></pre></td></tr></table></figure><blockquote><p>25026ms</p></blockquote><p>So with a transient HttpClient a working way to stay up to date with traffic manager configuration is to tune the <code>DnsRefreshTimeout</code> property to a good value for your application.</p><h4 id="Singleton"><a href="#Singleton" class="headerlink" title="Singleton"></a>Singleton</h4><p>Using a singleton client will reuse the connection for many requests to reduce the overhead with starting new TCP connections. In this setup we still want the connection to be recreated occasionally so we get the latest DNS configuration.</p><figure class="highlight csharp"><table><tr><td class="code"><pre><div class="line">[Fact]</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SingletonDnsChangeTest</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    HostsFile.Set(_hostname, <span class="string">"127.0.0.1"</span>);</div><div class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> SingletonHttpClient(<span class="keyword">new</span> Uri(<span class="string">$"http://<span class="subst">&#123;_hostname&#125;</span>:9200"</span>));</div><div class="line"></div><div class="line">    <span class="keyword">var</span> timer = Stopwatch.StartNew();</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">await</span> <span class="keyword">new</span> LoopUntilFailure(client).ExecuteAsync(</div><div class="line">            () =&gt; Task.Run(() =&gt; HostsFile.Set(_hostname, <span class="string">"128.0.0.1"</span>)));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span></div><div class="line">    &#123;</div><div class="line">        _logger.WriteLine(<span class="string">$"<span class="subst">&#123;<span class="keyword">typeof</span>(IHttpClient).Name&#125;</span> - <span class="subst">&#123;timer.ElapsedMilliseconds&#125;</span>"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><blockquote><p>Cancelled after 180000</p></blockquote><p>With a singleton HttpClient the connection is kept alive by default. This can be undesirable in configuration changes or scale out scenarios where you want your clients to connect to and use the new resources. Let’s try the <code>DnsRefreshTimeout</code>.</p><figure class="highlight csharp"><table><tr><td class="code"><pre><div class="line">ServicePointManager.DnsRefreshTimeout = <span class="number">10000</span>;</div></pre></td></tr></table></figure><blockquote><p>Cancelled after 180000</p></blockquote><p>Since the connection is open and kept open, we need to find a way to close it. There is another setting which controls the length of time a connection is held open for called <a href="https://msdn.microsoft.com/en-us/library/system.net.servicepoint.connectionleasetimeout.aspx" target="_blank" rel="external">ServicePointManager.ConnectionLeaseTimeout</a>.</p><figure class="highlight csharp"><table><tr><td class="code"><pre><div class="line">ServicePointManager.FindServicePoint(<span class="keyword">new</span> Uri(<span class="string">"http://testdns:9200"</span>))</div><div class="line">    .ConnectionLeaseTimeout = <span class="number">10000</span>;</div></pre></td></tr></table></figure><blockquote><p>145558</p></blockquote><p>Unfortunately, having this setting alone isn’t enough based on our previous transient experiments; the DNS is still cached. Let’s combine the two settings.</p><blockquote><p>33223</p></blockquote><p>So now, despite using a singleton pattern within the code, our connections are being recreated and re-resolved up to every 20 seconds (both timeouts combined).</p><p></p><div class="categories"><span>Posted in: </span><a href="/blog/categories/development/">development</a></div><div class="tags"><span>Tagged with: </span><a href="/blog/tags/NET/">.NET</a>, <a href="/blog/tags/C/">C#</a>, <a href="/blog/tags/azure/">azure</a></div><br><hr><div class="row"><div class="col-md-12"><h3>Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div></div></div><div id="push"></div></div><div id="footer"><div class="container"><div class="container"><br><p class="muted credit">&copy; 2016 Naeem Khedarun</p></div></div></div><script src="/js/all-8d7c4a0adc.min.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71815871-1', 'auto');
ga('send', 'pageview');</script><script type="text/javascript">var disqus_shortname = 'naeemkhedarun';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());</script></body></html>